<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Getting the forecast | Makerspace</title>
    <meta name="description" content="A resource/code reference for Makerspace Students">
    
    
    <link rel="preload" href="/makerspace/assets/css/0.styles.540581a7.css" as="style"><link rel="preload" href="/makerspace/assets/js/app.debd2f8d.js" as="script"><link rel="preload" href="/makerspace/assets/js/2.bea4a480.js" as="script"><link rel="preload" href="/makerspace/assets/js/9.bf962eeb.js" as="script"><link rel="prefetch" href="/makerspace/assets/js/10.699443e1.js"><link rel="prefetch" href="/makerspace/assets/js/11.41049e84.js"><link rel="prefetch" href="/makerspace/assets/js/12.671333a8.js"><link rel="prefetch" href="/makerspace/assets/js/13.6ba2dbe7.js"><link rel="prefetch" href="/makerspace/assets/js/14.a50c9fc8.js"><link rel="prefetch" href="/makerspace/assets/js/15.d6f48d3b.js"><link rel="prefetch" href="/makerspace/assets/js/16.ae199350.js"><link rel="prefetch" href="/makerspace/assets/js/17.6ca45d62.js"><link rel="prefetch" href="/makerspace/assets/js/18.c9dfb02d.js"><link rel="prefetch" href="/makerspace/assets/js/19.2a604709.js"><link rel="prefetch" href="/makerspace/assets/js/20.d4b160a3.js"><link rel="prefetch" href="/makerspace/assets/js/21.13c1f42e.js"><link rel="prefetch" href="/makerspace/assets/js/22.0fce7d9c.js"><link rel="prefetch" href="/makerspace/assets/js/23.13bcb06d.js"><link rel="prefetch" href="/makerspace/assets/js/24.bc10ba95.js"><link rel="prefetch" href="/makerspace/assets/js/25.e21cbaf1.js"><link rel="prefetch" href="/makerspace/assets/js/26.cf6f72b5.js"><link rel="prefetch" href="/makerspace/assets/js/3.1398b66e.js"><link rel="prefetch" href="/makerspace/assets/js/4.323a5bf8.js"><link rel="prefetch" href="/makerspace/assets/js/5.367d6021.js"><link rel="prefetch" href="/makerspace/assets/js/6.53284d11.js"><link rel="prefetch" href="/makerspace/assets/js/7.230cb609.js"><link rel="prefetch" href="/makerspace/assets/js/8.b0d3b231.js">
    <link rel="stylesheet" href="/makerspace/assets/css/0.styles.540581a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/makerspace/" class="home-link router-link-active"><!----> <span class="site-name">Makerspace</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/makerspace/" class="sidebar-link">Home</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/makerspace/programming-101/" class="sidebar-heading clickable"><span>Programming 101</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/makerspace/game-dev-resources/" class="sidebar-heading clickable"><span>Game Dev Resources</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/makerspace/kotlin/" class="sidebar-heading clickable"><span>Kotlin</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/makerspace/android/" class="sidebar-heading clickable router-link-active open"><span>Android</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/makerspace/android/weather/" class="sidebar-heading clickable router-link-active open"><span>Weather App</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/makerspace/android/weather/" class="sidebar-link">Android Weather App</a></li><li><a href="/makerspace/android/weather/start/" class="sidebar-link">Creating a new project</a></li><li><a href="/makerspace/android/weather/mvvm/" class="sidebar-link">MVVM</a></li><li><a href="/makerspace/android/weather/location/" class="sidebar-link">Getting the devices location</a></li><li><a href="/makerspace/android/weather/git/" class="sidebar-link">Git Integration</a></li><li><a href="/makerspace/android/weather/forecast/" class="active sidebar-link">Getting the forecast</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/makerspace/android/weather/forecast/#openweather-api" class="sidebar-link">OpenWeather API</a></li><li class="sidebar-sub-header"><a href="/makerspace/android/weather/forecast/#getting-data-from-an-api-retrofit" class="sidebar-link">Getting data from an API (Retrofit)</a></li><li class="sidebar-sub-header"><a href="/makerspace/android/weather/forecast/#using-weatherapi" class="sidebar-link">Using WeatherApi</a></li></ul></li><li><a href="/makerspace/android/weather/more-views/" class="sidebar-link">Adding More Data</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="getting-the-forecast"><a href="#getting-the-forecast" aria-hidden="true" class="header-anchor">#</a> Getting the forecast</h1> <p>In order to get the forecast data from the internet, we first need to tell Android that we want to use the internet. We need to add a new permission to the <code>AndroidManifest.xml</code>.</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>http://schemas.android.com/apk/res/android<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">package</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>com.example.weatherapp<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>android.permission.ACCESS_COARSE_LOCATION<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- NEW! --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>android.permission.INTERNET<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token comment">&lt;!-- ... --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="openweather-api"><a href="#openweather-api" aria-hidden="true" class="header-anchor">#</a> OpenWeather API</h2> <p>An <a href="https://en.wikipedia.org/wiki/Application_programming_interface" target="_blank" rel="noopener noreferrer">API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> stands for Application Programming Interface. People and companies make API's to allow others (and also themselves) to access their data in a more secure manner.</p> <p><a href="https://openweathermap.org" target="_blank" rel="noopener noreferrer">openweathermap.org<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> offers an API that's free to use (so long as we don't use it too much). We can find it at <a href="https://openweathermap.org/api" target="_blank" rel="noopener noreferrer">https://openweathermap.org/api<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Follow their <a href="https://openweathermap.org/appid" target="_blank" rel="noopener noreferrer">guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to create an account, and get an API key. Then subscribe to the <code>One Call Api</code> on the <a href="https://openweathermap.org/api" target="_blank" rel="noopener noreferrer">api list<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>The API key they give you will serve as identification when we ask the <code>openweathermap.org</code> for the forecast. We're going to need to store it to use it in our application. Create a new file called <code>Secrets.kt</code> (no class).</p> <div class="warning"><p>If you've set up Git integration, Android Studio will ask if you want to add this file to the repository. This is one of those times where you might <strong>not</strong> want it added.</p> <p>Secrets are meant to be secret. If your repository is <em>private</em>, then it should be no big deal if you add <code>Secrets.kt</code> to git. However, if you ever want to make the repo <em>public</em>, you'll have to remove the file from git <strong>and</strong> reset all your API keys and whatever other secret data you included.</p> <p>If you reject adding the file to Git, the filename will remain read. If you want it to stop being red you can right click the file and go to <code>Git | Add to .gitignore | app/.gitignore</code>.</p></div> <p>In <code>Secrets.kt</code> add a constant for the API key.</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>weatherapp

<span class="token keyword">const</span> <span class="token keyword">val</span> WEATHER_API_KEY <span class="token operator">=</span> <span class="token string">&quot;YOUR API KEY HERE&quot;</span>
</code></pre></div><p>We'll use this value soon.</p> <h2 id="getting-data-from-an-api-retrofit"><a href="#getting-data-from-an-api-retrofit" aria-hidden="true" class="header-anchor">#</a> Getting data from an API (Retrofit)</h2> <p>Now we need some way to access data on the internet. There are many solutions to this problem, but we are going to use a library called <a href="https://square.github.io/retrofit/" target="_blank" rel="noopener noreferrer">Retrofit<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. We're going to add some new dependencies to our <code>build.gradle</code>.</p> <div class="language-groovy extra-class"><pre class="language-groovy"><code>dependencies <span class="token punctuation">{</span> 
    <span class="token comment">// ...</span>

    <span class="token comment">// Retrofit</span>
    implementation <span class="token string gstring">&quot;com.squareup.retrofit2:retrofit:2.5.0&quot;</span>
    implementation <span class="token string gstring">&quot;com.squareup.retrofit2:converter-gson:2.5.0&quot;</span>
    implementation <span class="token string">'com.jakewharton.retrofit:retrofit2-kotlin-coroutines-adapter:0.9.2'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We're going to be using <a href="https://kotlinlang.org/docs/reference/coroutines/coroutines-guide.html" target="_blank" rel="noopener noreferrer">coroutines<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to make our job simpler, so we'll some more dependencies.</p> <div class="language-groovy extra-class"><pre class="language-groovy"><code>dependencies <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// Kotlin coroutines</span>
    implementation <span class="token string gstring">&quot;org.jetbrains.kotlinx:kotlinx-coroutines-core:1.1.1&quot;</span>
    implementation <span class="token string gstring">&quot;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.1.1&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once your project's synced, it's time to get into the code. Create a new Kotlin file called <code>WeatherApi</code>. It will contain an <code>interface</code> also called <code>WeatherApi</code>.</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">package</span> com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>weatherapp

<span class="token keyword">interface</span> WeatherApi <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We're going to use <a href="https://kotlinlang.org/docs/reference/annotations.html" target="_blank" rel="noopener noreferrer">annotations<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that <code>Retrofit</code> provides on a method called <code>getForecast()</code> to tell <code>Retrofit</code> how to access the OpenWeather API.</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token comment">// ...</span>

<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>Deferred
<span class="token keyword">import</span> retrofit2<span class="token punctuation">.</span>http<span class="token punctuation">.</span>GET
<span class="token keyword">import</span> retrofit2<span class="token punctuation">.</span>http<span class="token punctuation">.</span>Query

<span class="token keyword">interface</span> WeatherApi <span class="token punctuation">{</span>
    <span class="token comment">// Tell Retrofit where to get the data</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">&quot;data/2.5/onecall?appid=<span class="token interpolation"><span class="token delimiter variable">${</span>WEATHER_API_KEY<span class="token delimiter variable">}</span></span>&amp;exclude=hourly,minutely&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">getForecast</span><span class="token punctuation">(</span>
        <span class="token comment">// The parameters in the function will be used as</span>
        <span class="token comment">// query parameters in the resulting url</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;lat&quot;</span><span class="token punctuation">)</span> lat<span class="token operator">:</span> Double<span class="token punctuation">,</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;lon&quot;</span><span class="token punctuation">)</span> lon<span class="token operator">:</span> Double<span class="token punctuation">,</span>
        <span class="token comment">// This controls what units the temperature will be in:</span>
        <span class="token comment">// * Farenheit</span>
        <span class="token comment">// * Celcius</span>
        <span class="token comment">// * Kelvin (the default)</span>
        <span class="token comment">// We're specifying &quot;imperial&quot; to use Farenheit</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;units&quot;</span><span class="token punctuation">)</span> units<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">&quot;imperial&quot;</span>

    <span class="token comment">// We want to use coroutines, so we use Deferred here</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> Deferred<span class="token operator">&lt;</span>ForecastData<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>ForecastData</code> class hasn't been created yet. Let's do that now.</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token comment">// ...</span>

<span class="token keyword">interface</span> WeatherApi <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// NEW!</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">ForecastData</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> lat<span class="token operator">:</span> Double<span class="token punctuation">,</span>
    <span class="token keyword">val</span> lon<span class="token operator">:</span> Double<span class="token punctuation">,</span>
    <span class="token keyword">val</span> timezone<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">val</span> current<span class="token operator">:</span> ForecastDetails
<span class="token punctuation">)</span>

<span class="token comment">// NEW!</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">ForecastDetails</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> dt<span class="token operator">:</span> Long<span class="token punctuation">,</span>
    <span class="token keyword">val</span> temp<span class="token operator">:</span> Double<span class="token punctuation">,</span>
    <span class="token keyword">val</span> feels_like<span class="token operator">:</span> Double<span class="token punctuation">,</span>
    <span class="token keyword">val</span> weather<span class="token operator">:</span> List<span class="token operator">&lt;</span>WeatherData<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>

<span class="token comment">// NEW!</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">WeatherData</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> id<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token keyword">val</span> main<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">val</span> description<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">val</span> icon<span class="token operator">:</span> String
<span class="token punctuation">)</span>
</code></pre></div><div class="note"><p>These classes are based on the JSON returned by <a href="https://openweathermap.org/api/one-call-api" target="_blank" rel="noopener noreferrer">https://openweathermap.org/api/one-call-api<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. I've left out a lot of fields that the JSON provides. We currently only really need the ones I've specified.</p></div> <p>All we've done is specify the structure of our API. Now we need to use Retrofit to create it. We only want to create the API once, so we'll use an <code>object</code> to do that. We'll use <code>WeatherApi</code>'s <code>companion object</code> just to keep things simple.</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">import</span> com<span class="token punctuation">.</span>jakewharton<span class="token punctuation">.</span>retrofit2<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>kotlin<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>CoroutineCallAdapterFactory
<span class="token comment">// ...</span>
<span class="token keyword">import</span> retrofit2<span class="token punctuation">.</span>converter<span class="token punctuation">.</span>gson<span class="token punctuation">.</span>GsonConverterFactory
<span class="token comment">// ...</span>

<span class="token keyword">interface</span> WeatherApi <span class="token punctuation">{</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token comment">// Start building Retrofit</span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> retrofit <span class="token operator">=</span> Retrofit<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// Retrofit requires a baseUrl</span>
            <span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span><span class="token string">&quot;https://api.openweathermap.org/&quot;</span><span class="token punctuation">)</span>
            <span class="token comment">// This will convert the JSON blob we get</span>
            <span class="token comment">// from OpenWeatherMap into </span>
            <span class="token punctuation">.</span><span class="token function">addConverterFactory</span><span class="token punctuation">(</span>GsonConverterFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// This allows our getForecast() method</span>
            <span class="token comment">// to return Deferred&lt;*&gt;. Normally it would</span>
            <span class="token comment">// expect Retrofit's Call&lt;*&gt; class.</span>
            <span class="token punctuation">.</span><span class="token function">addCallAdapterFactory</span><span class="token punctuation">(</span><span class="token function">CoroutineCallAdapterFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// Finish the build process</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// Create the actual service using our WeatherApi</span>
        <span class="token comment">// interface.</span>
        <span class="token keyword">val</span> service<span class="token operator">:</span> WeatherApi <span class="token operator">=</span> retrofit<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>WeatherApi<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="using-weatherapi"><a href="#using-weatherapi" aria-hidden="true" class="header-anchor">#</a> Using WeatherApi</h2> <p>Now that we've created a service with Retrofit, it's time to us it. Fortunately the only change we need to make is in <code>WeatherViewModel</code>.</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token comment">// ...</span>
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>viewModelScope
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>Dispatchers
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>launch
<span class="token keyword">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span>withContext

<span class="token keyword">class</span> WeatherViewModel<span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">getForecast</span><span class="token punctuation">(</span>latitude<span class="token operator">:</span> Double<span class="token punctuation">,</span> longitude<span class="token operator">:</span> Double<span class="token punctuation">)</span><span class="token operator">:</span> LiveData<span class="token operator">&lt;</span>WeatherModel<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> result <span class="token operator">=</span> MutableLiveData<span class="token operator">&lt;</span>WeatherModel<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// UPDATED!</span>
        <span class="token comment">// Tells Android to launch a coroutine that will</span>
        <span class="token comment">// be canceled if the app is destroyed</span>
        viewModelScope<span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
            <span class="token comment">// Switch to an IO context. Make web requests</span>
            <span class="token comment">// on the UI thread will cause the app to</span>
            <span class="token comment">// crash.</span>
            result<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> forecast <span class="token operator">=</span> WeatherApi<span class="token punctuation">.</span>service
                    <span class="token comment">// The .await() bit is important. A</span>
                    <span class="token comment">// Deferred object needs to be awaited</span>
                    <span class="token comment">// before we can get any value from it.</span>
                    <span class="token comment">// This is because the value has not </span>
                    <span class="token comment">// been retrieved yet because it's</span>
                    <span class="token comment">// coming from the internet.</span>
                    <span class="token punctuation">.</span><span class="token function">getForecast</span><span class="token punctuation">(</span>latitude<span class="token punctuation">,</span> longitude<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token comment">// The last value in a lambda will be</span>
                <span class="token comment">// the return value. This is what</span>
                <span class="token comment">// `result.value` will be set to.</span>
                <span class="token function">WeatherModel</span><span class="token punctuation">(</span>forecast<span class="token punctuation">.</span>current<span class="token punctuation">.</span>temp<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> result
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>That should be everything. You should be seeing the current temperature in your location.</p> <p><img src="/makerspace/assets/img/temp-wrapping.91574920.png" alt=""></p> <p>The <code>F</code> being on the next line is annoying. We can fix that by making the text smaller, or you can format the text so it only includes one decimal place. I chose to do the latter.</p> <div class="language-kotlin extra-class"><pre class="language-kotlin"><code><span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fusedLocationProviderClient<span class="token punctuation">.</span>lastLocation
        <span class="token punctuation">.</span><span class="token function">addOnSuccessListener</span> <span class="token punctuation">{</span> location <span class="token operator">-&gt;</span>
            <span class="token keyword">val</span> viewModel<span class="token operator">:</span> WeatherViewModel <span class="token keyword">by</span> <span class="token function">viewModels</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            viewModel<span class="token punctuation">.</span><span class="token function">getForecast</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>latitude<span class="token punctuation">,</span> location<span class="token punctuation">.</span>longitude<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Observer <span class="token punctuation">{</span> forecast <span class="token operator">-&gt;</span>
                    <span class="token comment">// UPDATED!</span>
                    temperatureText<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">&quot;%.1f° F&quot;</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>forecast<span class="token punctuation">.</span>temperature<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token function">addOnFailureListener</span> <span class="token punctuation">{</span>
            Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">&quot;Unable to retrieve users location&quot;</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="note"><p>I'm using <a href="https://www.cplusplus.com/reference/cstdio/printf/" target="_blank" rel="noopener noreferrer">printf style formatting<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. A <code>%f</code> means put a float (or double in our case) here. <code>%.1f</code> means put a float here with one number after the decimal point.</p></div> <p><img src="/makerspace/assets/img/temp.02d50408.png" alt=""></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/makerspace/android/weather/git/" class="prev">Git Integration</a></span> <span class="next"><a href="/makerspace/android/weather/more-views/">Adding More Data</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/makerspace/assets/js/app.debd2f8d.js" defer></script><script src="/makerspace/assets/js/2.bea4a480.js" defer></script><script src="/makerspace/assets/js/9.bf962eeb.js" defer></script>
  </body>
</html>
